<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Product Detail</title>
    <link href="css/Style.css" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>
    <main>
        <div class="detail-container">
            <a href="javascript:history.back()" class="back-arrow">&#8592; Back</a>
            <div class="detail-card">
                <div class="detail-img-container">
                    <img id="detail-image" src="" alt="Product Image" />
                </div>
                <div class="details">
                    <div class="title" id="product-name"></div>
                    <div class="price" id="product-price"></div>
                    <div class="condition" id="product-condition"></div>
                    <div class="description" id="product-description"></div>
                    <div class="location" id="product-location"></div>
                    
                    <label for="quantity">Quantity:</label>
                    <select id="quantity" class="quantity-selector"></select>
                    <button class="add-to-cart" id="add-to-cart-btn">Add to Cart</button>
                </div>
            </div>
            <!-- Review Section -->
            <div class="review-section">
                <div class="average-rating" id="average-rating">
                    Average Rating: 0 (0 reviews)
                </div>
                <h3>Customer Reviews:</h3>
                <div id="reviews-container"></div>
            </div>  
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productID = urlParams.get('id');
        console.log('Product ID:', productID);  // Debugging product ID

        const restDBUrl = "https://mokesell-a998.restdb.io/rest/product";
        const apiKey = "67a77d8c4d87445a4b828040";
        
        // const restDBUrl = "https://assignment2-a8de.restdb.io/rest/fashion";
        // const apiKey = "67a7456d4d87445754828017";
        // const restDBUrl = "https://assignment2db-2aad.restdb.io/rest/fashion"; 
        // const apiKey = "678c8feb6f2ec083b7ee6d9c"; 

        // Check if data exists in localStorage
        if (localStorage.getItem('localProducts') && localStorage.getItem('restdbProducts') && localStorage.getItem('reviewsData')) {
            // If data exists, use it from localStorage
            const localProducts = JSON.parse(localStorage.getItem('localProducts'));
            const restdbProducts = JSON.parse(localStorage.getItem('restdbProducts'));
            const reviewsData = JSON.parse(localStorage.getItem('reviewsData'));
            loadProductData(localProducts, restdbProducts);
            loadReviewsData(reviewsData);
        } else {
            // Fetch product and review data from RESTdb and store it in localStorage
            fetchDataAndStore();
        }

        // Function to fetch data from RESTdb and store in localStorage
        function fetchDataAndStore() {
            Promise.all([
                fetch(restDBUrl, {
                    headers: { 'x-apikey': apiKey }
                }).then(response => response.json()),
                fetch(`https://mokesell-a998.restdb.io/rest/rating?productID=${productID}`, {
                    headers: { 'x-apikey': apiKey }
                }).then(response => response.json())
            ])
            .then(([restdbProducts, reviewsData]) => {
                console.log('Product Data from RESTdb:', restdbProducts);  // Debugging product data
                console.log('Reviews Data:', reviewsData);  // Debugging reviews data

                // Store fetched data in localStorage
                localStorage.setItem('restdbProducts', JSON.stringify(restdbProducts));
                localStorage.setItem('reviewsData', JSON.stringify(reviewsData));

                // Load the data to the page
                loadProductData(null, restdbProducts);
                loadReviewsData(reviewsData);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert("Failed to load product details. Please try again later.");
            });
        }

        // Function to load product data to the page
        function loadProductData(localProducts, restdbProducts) {
            // Prefer data from localProducts if available
            let product;
            if (localProducts) {
                product = localProducts.find(p => p.productID === productID);
            }

            // Fallback to restdbProducts if not found in localProducts
            if (!product && restdbProducts) {
                product = restdbProducts.find(p => p.productID === productID);
            }

            if (product) {
                document.getElementById('detail-image').src = product.photosurl || '';
                document.getElementById('product-name').textContent = product.name || 'Product Name';
                document.getElementById('product-price').textContent = `S$${product.price}`;
                document.getElementById('product-condition').textContent = `Condition: ${product.condition || 'Unknown'}`;
                document.getElementById('product-description').textContent = `Description: ${product.description || 'No description available.'}`;
                document.getElementById('product-location').textContent = `Location: ${product.location || 'Unknown'}`;

                const quantitySelect = document.getElementById('quantity');
                const availableStock = product.stock || 0;
                const maxQuantity = availableStock < 3 ? availableStock : 3;

                for (let i = 1; i <= maxQuantity; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    quantitySelect.appendChild(option);
                }

                if (availableStock === 0) {
                    quantitySelect.disabled = true;
                    document.querySelector('.add-to-cart').disabled = true;
                }
            } else {
                console.error('Product not found for the given productID:', productID);
            }
        }

        // Function to load reviews data to the page
        function loadReviewsData(reviewsData) {
            const reviews = reviewsData.filter(review => review.productID === productID);
            console.log('Filtered Reviews:', reviews);  // Debugging filtered reviews
            updateAverageRating(reviews);
            displayReviews(reviews);
        }

        // Function to update the average rating
        function updateAverageRating(reviews) {
            if (reviews.length > 0) {
                const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
                const average = totalRating / reviews.length;
                document.getElementById('average-rating').textContent = `Average Rating: ${average.toFixed(1)} (${reviews.length} reviews)`;
            } else {
                document.getElementById('average-rating').textContent = 'Average Rating: 0 (0 reviews)';
            }
        }

        // Function to display reviews with Material Icons for star ratings
        function displayReviews(reviews) {
            const reviewsContainer = document.getElementById('reviews-container');
            reviewsContainer.innerHTML = '';

            if (reviews.length > 0) {
                reviews.forEach(review => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.classList.add('review');

                    const starRating = document.createElement('div');
                    starRating.classList.add('star-rating');
                    const rating = review.rating;
                    let stars = '';
                    for (let i = 0; i < 5; i++) {
                        if (i < rating) {
                            stars += `<span class="material-icons-round">star</span>`;
                        } else {
                            stars += `<span class="material-icons-round">star_outline</span>`;
                        }
                    }
                    starRating.innerHTML = stars;
                    reviewDiv.appendChild(starRating);

                    const reviewText = document.createElement('p');
                    reviewText.textContent = `"${review.reviewText}"`;
                    reviewDiv.appendChild(reviewText);

                    const reviewMeta = document.createElement('div');
                    reviewMeta.classList.add('review-meta');
                    reviewMeta.textContent = `- ${review.name} (Verified Purchase: ${review.verifiedPurchase ? 'Yes' : 'No'})`;
                    reviewDiv.appendChild(reviewMeta);

                    reviewsContainer.appendChild(reviewDiv);
                });
            } else {
                reviewsContainer.innerHTML = '<p>No reviews yet.</p>';
            }
        }
    </script>
    <script src="js/script.js"></script>
</body>
</html>
