<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Product Detail</title>
    <link href="css/Style.css" rel="stylesheet"> 
</head>
<body>
    <main>
        <div class="detail-container">
            <a href="javascript:history.back()" class="back-arrow">&#8592; Back</a>
            <div class="detail-card">
                <div class="detail-img-container">
                    <img id="detail-image" src="" alt="Product Image" />
                </div>
                <div class="details">
                    <div class="title" id="product-name"></div>
                    <div class="price" id="product-price"></div>
                    <div class="condition" id="product-condition"></div>
                    <div class="description" id="product-description"></div>
                    <div class="location" id="product-location"></div>
                    
                    <label for="quantity">Quantity:</label>
                    <select id="quantity" class="quantity-selector"></select>
                    <button class="add-to-cart">Add to Cart</button>
                </div>
            </div>
            <!-- Review Section -->
            <div class="review-section">
                <div class="average-rating" id="average-rating">
                    Average Rating: 0 (0 reviews)
                </div>
                <h3>Customer Reviews:</h3>
                <div id="reviews-container"></div>
            </div>  
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productID = urlParams.get('id');
        //const restDBUrl = "https://assignment2db-2aad.restdb.io/rest/fashion";  // RESTdb API for products
        const restDBUrl = "https://assignment2-a8de.restdb.io/rest/fashion";
        //const apiKey = "678c8feb6f2ec083b7ee6d9c"; // Your API key for RESTdb
        const apiKey = "67a7456d4d87445754828017";
        
        // Fetch both local JSON data and RESTdb API data concurrently
        Promise.all([
            // Fetch data from local JSON file
            fetch('products.json').then(response => response.json()), 
            
            // Fetch data from RESTdb API
            fetch(restDBUrl, {
                headers: {
                    'x-apikey': apiKey  // Include the API key for RESTdb
                }
            }).then(response => response.json())
        ])
        .then(([localData, restdbData]) => {
            // Combine data or choose which one to use
            const product = restdbData.find(p => p.productID === productID) || localData.find(p => p.productID === productID);

            if (product) {
                document.getElementById('detail-image').src = product.photosurl || '';
                document.getElementById('product-name').textContent = product.name || 'Product Name';
                document.getElementById('product-price').textContent = `S$${product.price}`;
                document.getElementById('product-condition').textContent = `Condition: ${product.condition || 'Unknown'}`;
                document.getElementById('product-description').textContent = `Description: ${product.description || 'No description available.'}`;
                document.getElementById('product-location').textContent = `Location: ${product.location || 'Unknown'}`;

                const quantitySelect = document.getElementById('quantity');
                const availableStock = product.stock || 0;
                const maxQuantity = availableStock < 3 ? availableStock : 3;

                for (let i = 1; i <= maxQuantity; i++) {
                    let option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    quantitySelect.appendChild(option);
                }

                if (availableStock === 0) {
                    quantitySelect.disabled = true;  // Disable quantity selector if no stock
                    document.querySelector('.add-to-cart').disabled = true; // Disable 'Add to Cart' button
                }

                // Fetch reviews from RESTDB
                /*fetch(`https://assignment2db-2aad.restdb.io/rest/review-rating-collection?productID=${productID}`, {
                    headers: { "x-apikey": apiKey }
                })*/
                fetch(`https://assignment2-a8de.restdb.io/rest/review-rating-collection?productID=${productID}`, {
                    headers: { "x-apikey": apiKey }
                })
                .then(response => response.json())
                .then(reviewsData => {
                    // Ensure reviewsData is an array and contains reviews for the specific product
                    const reviews = reviewsData.filter(review => review.productID === productID);
                    updateAverageRating(reviews);
                    displayReviews(reviews);
                })
                .catch(error => console.error('Error fetching reviews:', error));
            } else {
                document.getElementById('product-detail').innerHTML = '<p>Product not found.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading product data:', error);
        });

        // Function to update the average rating
        function updateAverageRating(reviews) {
            if (reviews.length > 0) {
                const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);  // Use review.rating
                const average = totalRating / reviews.length;
                document.getElementById('average-rating').textContent = `Average Rating: ${average.toFixed(1)} (${reviews.length} reviews)`;
            } else {
                document.getElementById('average-rating').textContent = 'Average Rating: 0 (0 reviews)';
            }
        }

        // Function to display reviews
        function displayReviews(reviews) {
            const reviewsContainer = document.getElementById('reviews-container');
            reviewsContainer.innerHTML = ''; // Clear previous reviews

            if (reviews.length > 0) {
                reviews.forEach(review => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.classList.add('review');
                    
                    const reviewText = document.createElement('p');
                    reviewText.textContent = `"${review.reviewText}"`;
                    reviewDiv.appendChild(reviewText);

                    const reviewMeta = document.createElement('div');
                    reviewMeta.classList.add('review-meta');
                    reviewMeta.textContent = `- ${review.name} (Verified Purchase: ${review.verifiedPurchase ? 'Yes' : 'No'})`;
                    reviewDiv.appendChild(reviewMeta);

                    reviewsContainer.appendChild(reviewDiv);
                });
            } else {
                // If no reviews, show "No reviews yet."
                reviewsContainer.innerHTML = '<p>No reviews yet.</p>';
            }
        }
    </script>
    <script src="js/script.js"></script>
</body>
</html>
